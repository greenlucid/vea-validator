# Implementation Faults & Pending Work

## Critical Missing Feature

### Proof Relay Execution NOT Implemented
**Location**: [main.rs:236-244](main.rs#L236-L244)

The handler is a TODO. Spec says to call `constructOutboxProof(ticketID)` then `Outbox.executeTransaction()` after 7-day delay.

**The problem**: This is fundamentally unclear because:
- `NodeInterface.constructOutboxProof(size, leaf)` needs `size` and `leaf` index in the outbox accumulator
- `Outbox.executeTransaction(proof, index, l2Sender, to, l2Block, l1Block, l2Timestamp, value, data)` needs 9 parameters
- `SnapshotSent` event only gives `ticketID` (return value from `ARB_SYS.sendTxToL1`)
- `ticketID` ≠ `leaf` index - they're different identifiers

**Core question**: When `inbox.sendSnapshot()` is called at [VeaInboxArbToEth.sol:204](../contracts/src/arbitrumToEth/VeaInboxArbToEth.sol#L204), it queues a message in Arbitrum's canonical Outbox on L1. **Anyone can execute it** after 7 days - this is typically a separate relayer/bot service, not validator logic.

Is proof relay even the validator's responsibility? Spec conflates validator duties (defend bridge via challenges) with relayer duties (execute queued L2→L1 messages).

## Code Duplication Violations (NOT DRY)

### Duplicate Claim Conversion Functions
**Location**: [main.rs:41-63](main.rs#L41-L63)

`claim_to_arb_eth()` and `claim_to_arb_gnosis()` are identical conversion logic. Should be one generic function or macro.

### Duplicate Bridge Resolver Closures
**Location**: [main.rs:265-323](main.rs#L265-L323)

`arb_to_eth_resolver` and `arb_to_gnosis_resolver` differ only in:
- Contract type (IVeaInboxArbToEth vs IVeaInboxArbToGnosis)
- `sendSnapshot` signature (one takes `gas_limit` parameter)

Should abstract this duplication.

## Excessive Whitespace Violations

Empty lines throughout violating "Don't use excessive empty whitelines":
- [main.rs:64](main.rs#L64)
- [main.rs:103](main.rs#L103)
- [claim_handler.rs:29](claim_handler.rs#L29)
- [claim_handler.rs:41](claim_handler.rs#L41)
- [claim_handler.rs:65](claim_handler.rs#L65)
- [claim_handler.rs:95](claim_handler.rs#L95)
- [claim_handler.rs:135](claim_handler.rs#L135)
- [claim_handler.rs:147](claim_handler.rs#L147)
- [claim_handler.rs:162](claim_handler.rs#L162)
- [claim_handler.rs:219](claim_handler.rs#L219)
- [claim_handler.rs:236](claim_handler.rs#L236)
- [claim_handler.rs:253](claim_handler.rs#L253)
- [claim_handler.rs:266](claim_handler.rs#L266)
- [epoch_watcher.rs:11](epoch_watcher.rs#L11)
- [epoch_watcher.rs:15](epoch_watcher.rs#L15)
- [epoch_watcher.rs:21](epoch_watcher.rs#L21)
- [epoch_watcher.rs:33](epoch_watcher.rs#L33)
- [epoch_watcher.rs:62](epoch_watcher.rs#L62)
- [event_listener.rs:8](event_listener.rs#L8)
- [event_listener.rs:16](event_listener.rs#L16)
- [event_listener.rs:23](event_listener.rs#L23)
- [event_listener.rs:28](event_listener.rs#L28)
- [event_listener.rs:35](event_listener.rs#L35)
- [event_listener.rs:79](event_listener.rs#L79)
- [event_listener.rs:118](event_listener.rs#L118)
- [proof_relay.rs:7](proof_relay.rs#L7)
- [proof_relay.rs:9](proof_relay.rs#L9)
- [proof_relay.rs:13](proof_relay.rs#L13)
- [proof_relay.rs:18](proof_relay.rs#L18)
- [proof_relay.rs:23](proof_relay.rs#L23)
- [proof_relay.rs:52](proof_relay.rs#L52)
- [config.rs:6](config.rs#L6)
- [config.rs:18](config.rs#L18)
- [config.rs:75](config.rs#L75)
- [config.rs:82](config.rs#L82)
- [config.rs:111](config.rs#L111)

## Comments Violation

### Excessive Comments
**Location**: [main.rs:306](main.rs#L306)

`// dummy wallet for tests` - spec says no excessive comments.

**Location**: [claim_handler.rs:307](claim_handler.rs#L307)

`// No WETH for ARB_TO_ETH route` - unnecessary comment.

**Location**: [claim_handler.rs:311](claim_handler.rs#L311)

`// This mainly verifies the setup is correct` - unnecessary comment.

## Code That Must Be Removed

### Fallback Claim Fetching
**Location**: [claim_handler.rs:115-133](claim_handler.rs#L115-L133)

The fallback pattern where we query historical logs when a claim exists but isn't in local storage. This includes:
- The log query logic at lines 115-133
- Helper function `parse_claim_from_log` at [claim_handler.rs:42-64](claim_handler.rs#L42-L64)

NOT in spec. Need cleaner approach.

### Inline Test Module
**Location**: [claim_handler.rs:267-315](claim_handler.rs#L267-L315)

Entire `#[cfg(test)] mod tests` block. Tests should be external per project structure, not inline.

## Pending Decisions

### Before Epoch Message Check
**Current**: [claim_handler.rs:220-235](claim_handler.rs#L220-L235) only checks if snapshot already exists.

**Spec says**: "check if there are any unsaved messages in the inbox, if so, call `saveSnapshot()`"

Should we check `inbox.count()` vs last saved count? Or is contract-internal check sufficient? Needs clarification.