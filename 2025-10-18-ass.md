# WHAT'S LEFT

Date: 2025-10-19

## Spec vs Implementation Gap Analysis

Read entire spec in `final_for_real.md`. Read entire `src/`. Here's what's MISSING:

### 1. BEFORE_EPOCH_BUFFER & AFTER_EPOCH_BUFFER timing
**Spec says:**
- Track epochs with time-based triggers
- BEFORE_EPOCH_BUFFER seconds before epoch ends → check unsaved messages, call `saveSnapshot()`
- AFTER_EPOCH_BUFFER after epoch ends → check if last epoch saved, if so check outbox for claim, if not make claim

**Reality:**
- [epoch_watcher.rs:24-36](epoch_watcher.rs#L24-L36) just polls every 10s and calls handler with current epoch
- NO buffer-based timing
- `handle_epoch_end()` is called continuously on CURRENT epoch, not "before next epoch ends"
- Claiming happens via SnapshotSaved event reaction, not via "AFTER_EPOCH_BUFFER after epoch ends"

**What's needed:**
- Calculate when current epoch ends
- Trigger action BEFORE_EPOCH_BUFFER seconds before that
- Trigger action AFTER_EPOCH_BUFFER seconds after that
- Remove event-based claiming (SnapshotSaved listener needs to be removed, as it's no longer used)

### 2. SnapshotSent event → 7 day wait → proof relay
**Spec says:**
- Listen to `SnapshotSent(ticketID)` event from inbox
- Wait 7 days + 10 minutes from when event emitted
- Then call `constructOutboxProof(ticketID)` and `Outbox.executeTransaction()`

**Reality:**
- SnapshotSent event exists in [contracts.rs:9](contracts.rs#L9) and [contracts.rs:78](contracts.rs#L78)
- ZERO listeners for it anywhere
- NO proof relay mechanism exists

**What's needed:**
- EventListener watching SnapshotSent
- Store ticketID + timestamp when seen
- After 7 days + 10 min, call constructOutboxProof(ticketID) then Outbox.executeTransaction()
- (Research: where is constructOutboxProof? Not in current contracts interface)

### 3. VerificationStarted event handling
**Spec says:**
- "on listen to Start verification event: apparently, nothing?! research..."

**Reality:**
- Event exists: [contracts.rs:59](contracts.rs#L59), [contracts.rs:128](contracts.rs#L128)
- Not listened to
- Spec says "research" so unclear if action needed, but should be researched

### 4. Redundant/unused code to NUKE

**config.rs:**
- [config.rs:77-90](config.rs#L77-L90): `setup_arb_to_eth()` and `setup_arb_to_gnosis()` - NEVER CALLED
- [config.rs:92-99](config.rs#L92-L99): `ProvidersWithWallet` struct - NEVER USED
- [config.rs:108-128](config.rs#L108-L128): `setup_providers_with_wallet()` - NEVER CALLED

**main.rs:**
- [main.rs:149](main.rs#L149): sync_from 100 epochs back - arbitrary number, not in spec
- [main.rs:151-156](main.rs#L151-L156): startup_sync_and_verify - NOT in spec (though defensive, decide if keep)

**claim_handler.rs:**
- [claim_handler.rs:101-125](claim_handler.rs#L101-L125): `sync_existing_claims()` - only called by startup_sync_and_verify which isn't in spec
- [claim_handler.rs:279-294](claim_handler.rs#L279-L294): `startup_sync_and_verify()` - NOT in spec

**contracts.rs:**
- [contracts.rs:144-172](contracts.rs#L144-L172): IRouterArbToGnosis - NEVER USED
- [contracts.rs:174-183](contracts.rs#L174-L183): IAMB - NEVER USED

## Summary: What to DO

1. **FIX epoch timing:** Implement proper BEFORE_EPOCH_BUFFER / AFTER_EPOCH_BUFFER triggers
2. **ADD SnapshotSent listener:** Implement 7-day delayed proof relay
3. **RESEARCH VerificationStarted:** Figure out if action needed
4. **NUKE redundant code:** Delete all unused functions, tests, structs, contract interfaces
